DNZO=Object.extend(DNZO,{load:function(B){var A=$("switcher");if(A){A.observe("change",DNZO.onSwitchList)}$$("a.dialog").each(function(C){new ModalDialog(C)});DNZO.verifyTimezone()},onSwitchList:function(A){document.location.href=$F(A.element())},verifyTimezone:function(){if(DNZO.timezoneInfo.updateUrl.length==0){return}var A=(new Date()).getTimezoneOffset();if(DNZO.timezoneInfo.offset!=A){new Ajax.Request(DNZO.timezoneInfo.updateUrl,{parameters:{offset:A},method:"post"})}}});Event.observe(window,"load",DNZO.load);var InstantAutocompleter=Class.create({initialize:function(B,D,A){var C={firstSelected:true};this.options=Object.extend(C,(typeof A!="undefined")?A:{});this.element=B;this.collection=D;this.updateElement=new Element("ul",{className:"autocompleter"});this.updateElement.hide();this.element.parentNode.appendChild(this.updateElement);this.wireEvents();this.reset()},wireEvents:function(){this.element.observe("focus",this.onFocus.bind(this));this.element.observe("keydown",this.onKeyDown.bind(this));this.element.observe("keyup",this.onKeyUp.bind(this))},reset:function(A){this.updateElement.hide();this.selectedIndex=-1;this.value=null;this.dontReappear=false;this.matches=[]},onFocus:function(A){this.reset()},onKeyDown:function(B){this.wasShown=this.isShown();if(this.dontReappear){return}var A=false;switch(B.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.selectEntry();this.dontReappear=true;break;case Event.KEY_ESC:this.hide();this.dontReappear=true;A=true;break;case Event.KEY_LEFT:case Event.KEY_RIGHT:break;case Event.KEY_UP:this.markPrevious();A=true;break;case Event.KEY_DOWN:this.markNext();A=true;break}if(A){B.stop()}},onKeyUp:function(A){var B=this.valueChanged();if(this.value.blank()){this.reset()}else{if(this.wasShown){A.stop()}if(B&&!this.dontReappear){this.updateOptions()}}},isShown:function(){return this.updateElement.visible()},show:function(){this.updateElement.absolutize();this.updateElement.setStyle({height:null});Position.clone(this.element,this.updateElement,{setHeight:false,offsetTop:this.element.offsetHeight});this.updateElement.show()},hide:function(){this.updateElement.hide()},valueChanged:function(){var A=this.value;this.value=this.element.getValue();return this.value!=A},updateOptions:function(){var A=this.getSelectedValue();this.updateElement.innerHTML="";this.matches=this.getMatches();if(this.matches.length==0){this.hide();return}this.selectedIndex=this.options.firstSelected?0:-1;this.matches.each(function(D,C){var B=new Element("li");B.innerHTML=D;this.updateElement.appendChild(B);if(D==A){this.selectedIndex=C}},this);this.updateSelected();if(!this.isShown()){this.show()}},getSelectedValue:function(){return this.matches[this.selectedIndex]},getSelectedElement:function(){return this.updateElement.select("li")[this.selectedIndex]},updateSelected:function(){var B=this.updateElement.select("li");B.each(function(C,D){C.removeClassName("selected")});var A=this.getSelectedElement();if(A){A.addClassName("selected")}},getMatches:function(){var A=this.getRegex();return this.collection.collect(function(B){if(B.match(A)){return B}return null}).reject(function(B){return !B})},getRegex:function(){return new RegExp("\\b"+this.value,"i")},markPrevious:function(){if(this.selectedIndex<0){return}this.selectedIndex-=1;this.updateSelected()},markNext:function(){if(this.selectedIndex==this.matches.length-1){return}this.selectedIndex+=1;this.updateSelected()},selectEntry:function(){var A=this.getSelectedValue();if(A){this.element.setValue(A)}this.reset()}});var ModalDialog=Class.create({initialize:function(B,A){if(B.match("a")){this.href=B.href;this.method="get"}else{if(B.match("input")){var C=B.up("form");this.href=C.action;this.method=C.method}}B.observe("click",this.onClickShow.bind(this));this.createElements();this.options=A||{}},createElements:function(){if(this.blackout){this.blackout.remove()}this.blackout=new Element("div");this.blackout.addClassName("blackout");this.blackout.setStyle({position:"absolute",display:"none",background:"black"});if(this.container){this.container.remove()}this.container=new Element("div");this.container.addClassName("dialog_container");var B=new Element("div");B.addClassName("loading");this.container.appendChild(B);this.container.setStyle({position:"absolute",display:"none"});var A=$("body");A.appendChild(this.blackout);A.appendChild(this.container)},position:function(){var C=this.container.getDimensions();var B=document.viewport.getScrollOffsets();var A=document.viewport.getDimensions();var E=(A.height/4)-(C.height/4)+B.top;var D=(A.width/2)-(C.width/2)+B.left;this.blackout.setStyle({top:B.top+"px",left:B.left+"px",width:"100%",height:"100%"});this.container.setStyle({left:D+"px",top:E+"px"})},onClickShow:function(A){A.stop();this.show()},onClickHide:function(A){A.stop();this.hide()},onScroll:function(A){this.position()},show:function(){if(this.effecting){return}if(!this.isLoaded){this.load()}this.effecting=true;this.boundOnScroll=this.onScroll.bind(this);Event.observe(window,"scroll",this.boundOnScroll);this.position();new Effect.Parallel([new Effect.Appear(this.blackout,{from:0,to:0.2,sync:true}),new Effect.Appear(this.container,{sync:true})],{duration:0.25,afterFinish:this.doShow.bind(this)})},doShow:function(){this.effecting=false;this.afterShown()},afterShown:function(){if(!this.isLoaded){return}if(this.options.afterShown){this.options.afterShown()}},load:function(){if(!this.isLoading){new Ajax.Request(this.href,{method:this.method,onSuccess:this.doLoad.bind(this),afterComplete:(function(A){this.isLoading=false}).bind(this)})}},doLoad:function(A){this.container.innerHTML=A.responseText;this.container.select(".hide_dialog").each((function(B){B.observe("click",this.onClickHide.bind(this))}).bind(this));this.position();this.isLoaded=true;this.afterShown()},hide:function(){if(this.effecting){return}this.effecting=true;if(this.boundOnScroll){Event.stopObserving(window,"scroll",this.boundOnScroll);this.boundOnScroll=null}new Effect.Parallel([new Effect.Fade(this.blackout,{sync:true}),new Effect.Fade(this.container,{sync:true})],{duration:0.25,afterFinish:(function(){this.effecting=false}).bind(this)})}});var TaskRow=Class.create({initialize:function(A,B){this.editEventsWired=false;if(A){this.viewRow=A;this.wireViewingEvents(this.viewRow)}if(B){this.editRow=B;if(!A||this.editRow.visible()){this.wireEditingEvents(this.editRow)}}this.boundOnOtherTaskEditing=this.onOtherTaskEditing.bind(this);Tasks.table.observe(Tasks.TASK_EDITING_EVENT,this.boundOnOtherTaskEditing)},wireViewingEvents:function(B){this.editLink=B.select(".edit>a.edit")[0];this.editLink.observe("click",this.onClickEdit.bind(this));this.trashcan=B.select(".edit>a.delete")[0];this.trashcan.observe("click",this.onClickTrash.bind(this));var A=B.select(".complete")[0];A.observe("click",this.onClickComplete.bind(this));B.observe("dblclick",this.onDoubleClickViewRow.bind(this));this.wireDragging(this.viewRow)},wireEditingEvents:function(B){var A=B.select(".edit>input[type=submit]")[0];A.observe("click",this.onClickSave.bind(this));B.observe("keyup",this.onKeyUp.bind(this));this.cancelLink=B.select(".edit>a.cancel")[0];this.boundOnClickCancel=this.onClickCancel.bind(this);this.cancelLink.observe("click",this.boundOnClickCancel);this.wireProjectAutocomplete(B);this.wireContextAutocomplete(B);this.editEventsWired=true},wireDragging:function(A){if(!Tasks.sortable()){return}new Draggable(A,{starteffect:null,endeffect:null,revert:true,ghosting:false,constraint:"vertical",onStart:this.onStartDrag.bind(this),onEnd:this.onStopDrag.bind(this),onDrag:this.onDrag.bind(this)})},wireProjectAutocomplete:function(B){var A=B.select("td.project>input").first();new InstantAutocompleter(A,DNZO.projects,{firstSelected:false})},wireContextAutocomplete:function(A){var B=A.select("td.context>input").first()},destroy:function(){if(this.viewRow){this.viewRow.remove()}if(this.editRow&&this.editRow.parentNode){this.editRow.remove()}this.ignoreCancels()},ignoreCancels:function(){Event.stopObserving(this.cancelLink,"click",this.boundOnClickCancel);this.cancelLink.href=null;Event.stopObserving(Tasks.table,Tasks.TASK_EDITING_EVENT,this.boundOnOtherTaskEditing)},isEditing:function(){return this.editRow&&this.editRow.visible()},isCompleted:function(){return this.viewRow&&this.viewRow.hasClassName("completed")},fire:function(B,A){Event.fire((this.viewRow||this.editRow),B,A)},taskAbove:function(){var A=this.viewRow.previousSiblings().find(function(B){return B.match("tr.task-row")&&!B.hasClassName("editable")});return Tasks.idFromViewRow(A)},taskBelow:function(){var A=this.viewRow.nextSiblings().find(function(B){return B.match("tr.task-row")&&!B.hasClassName("editable")});return Tasks.idFromViewRow(A)},onClickEdit:function(A){A.stop();this.edit();this.activate()},onClickCancel:function(A){A.stop();this.cancel()},onClickTrash:function(A){A.stop();this.trash()},onClickSave:function(D){var E={x:D.pointerX(),y:D.pointerY()};if(E.x!=0||E.y!=0){var B=D.element();var C=B.getDimensions();var A=B.cumulativeOffset();inX=E.x>=A.left&&E.x<=A.left+C.width;inY=E.y>=A.top&&E.y<=A.top+C.height;if(inX&&inY){this.save()}}D.stop()},onClickComplete:function(C){if(this.isEditing()){return}var A=C.element();var B=A.checked;this.completeOrUncomplete(B,{onFailure:this.doFail.bind(this)})},onDoubleClickViewRow:function(C){C.stop();var A=C.element();var D=(A.match("td"))?A:A.up("td");var B=null;if(D){B=D.classNames().toArray().first();if(["edit","done"].include(B)){return}}this.edit();this.activate(B)},onKeyUp:function(A){switch(A.keyCode){case Event.KEY_RETURN:this.save();break;case Event.KEY_ESC:this.cancel();break}},onOtherTaskEditing:function(A){if(this.isEditing()){this.cancel()}},onStartDrag:function(A,B){this.viewRow.addClassName("dragging");this.viewRow.up("table").addClassName("row-dragging");this.recordPosition();this.findDragBounds()},onStopDrag:function(A,B){this.viewRow.removeClassName("dragging");this.viewRow.up("table").removeClassName("row-dragging");this.savePosition()},onDrag:function(A,F){var E=document.viewport.getScrollOffsets().top;var G=F.clientY+E;var D,B=null;var C=0;if(this.canMoveUp&&G<this.topDragBounds.first()){if(this.topDragBounds.length>1){B=this.topDragBounds.find(function(H){return G>H});C=B?this.topDragBounds.indexOf(B)-1:this.topDragBounds.length-1}D=this.aboveNeighbors[C];this.moveUp(D)}else{if(this.canMoveDown&&G>this.bottomDragBounds.first()){if(this.bottomDragBounds.length>1){B=this.bottomDragBounds.find(function(H){return G<H});C=B?this.bottomDragBounds.indexOf(B)-1:this.bottomDragBounds.length-1}D=this.belowNeighbors[C];this.moveDown(D)}}},findDragBounds:function(){var B=function(C){return C.match("tr.task-row")&&C.visible()};this.aboveNeighbors=this.viewRow.previousSiblings().findAll(B);this.belowNeighbors=this.viewRow.nextSiblings().findAll(B).reject(function(C){return C.hasClassName("unsaved")});var A=this.viewRow.getDimensions().height;this.canMoveUp=this.aboveNeighbors.length>0;this.topDragBounds=null;if(this.canMoveUp){this.topDragBounds=this.aboveNeighbors.collect(function(D){var C=D.getDimensions().height;return D.cumulativeOffset().top+C-(C>A?C-A:0)})}this.canMoveDown=this.belowNeighbors.length>0;this.bottomDragBounds=null;if(this.canMoveDown){this.bottomDragBounds=this.belowNeighbors.collect(function(C){return C.cumulativeOffset().top})}},moveUp:function(A){var B=A.hasClassName("editable")?A:A.previousSiblings()[0];this.moveAboveRow(B);this.findDragBounds()},moveDown:function(A){var B=A.hasClassName("editable")?A.nextSiblings()[1]:A.nextSiblings()[0];this.moveAboveRow(B);this.findDragBounds()},moveAboveRow:function(A){this.viewRow.remove();this.editRow.remove();A.parentNode.insertBefore(this.editRow,A);A.parentNode.insertBefore(this.viewRow,A)},edit:function(){if(this.isCompleted()){return}this.fire(Tasks.TASK_EDITING_EVENT);if(!this.editEventsWired){this.wireEditingEvents(this.editRow)}this.viewRow.hide();this.editRow.show();this.activate()},cancel:function(){this.fire(Tasks.TASK_CANCEL_EDITING_EVENT);if(this.viewRow){this.viewRow.show();this.editRow.hide()}else{this.destroy()}},trash:function(){if(!this.requestedTrash){this.requestedTrash=true;new Ajax.Request(this.trashcan.href,{method:"get",onSuccess:this.doTrash.bind(this),onFailure:this.doFail.bind(this),onComplete:(function(A){this.requestedTrash=false}).bind(this)})}},doTrash:function(A){Tasks.updateStatusFromResponse(A);this.destroy()},save:function(){if(!this.isSaving){this.isSaving=true;var A=null;if(this.viewRow){A=this.editLink.href}Tasks.saveTask(A,this.editRow,{onSuccess:this.doSave.bind(this),onFailure:this.doFail.bind(this),onComplete:(function(B){this.isSaving=false}).bind(this)});this.editRow.select("input").each(function(B){B.disable()});this.ignoreCancels();this.fire(Tasks.TASK_SAVED_EVENT,this.editRow)}},doSave:function(A){this.replaceRows(A)},completeOrUncomplete:function(A,B){var C={};if(A){C.force_complete=true;this.viewRow.addClassName("completed")}else{C.force_uncomplete=true;this.viewRow.removeClassName("completed")}defaultOptions={method:"post",parameters:C,onSuccess:this.doComplete.bind(this),onFailure:this.doFail.bind(this)};if(B){for(p in B){defaultOptions[p]=B[p]}}new Ajax.Request(this.editLink.href,defaultOptions)},doComplete:function(A){},recordPosition:function(){var A=this.position;this.position={task_above:this.taskAbove(),task_below:this.taskBelow()};return Object.toJSON(A||{})!=Object.toJSON(this.position)},savePosition:function(){if(!Tasks.sortable()){return}if(this.recordPosition()){new Ajax.Request(this.editLink.href,{method:"post",onSuccess:this.doSavePosition.bind(this),onFailure:this.doFail.bind(this),parameters:this.position})}},doSavePosition:function(A){},doFail:function(A){Tasks.doFail(A)},replaceRows:function(F){if(this.viewRow){this.viewRow.remove()}var B=this.editRow.parentNode;var A=Tasks.containerFromResponse(F);var D=A.select("tr");var E=D.find(function(G){return G.hasClassName("editable")});var C=D.without(E)[0];B.insertBefore(E,this.editRow);B.insertBefore(C,this.editRow);this.editRow.remove();this.initialize(C,E)},activate:function(B){if(!this.editRow){return}if(!B){var A=this.editRow.select("td.task>input").first();var E=this.editRow.select("td.project>input").first();if(A&&E){var D=E.getDimensions().width>0;if(A.getValue().blank()&&E.getValue().blank()&&D){E.activate()}else{A.activate()}}}else{var C=this.editRow.select("td."+B+">input").first();if(C){C.activate()}}}});var Tasks={TASK_SAVED_EVENT:"tasks:task_saved",TASK_EDITING_EVENT:"tasks:task_editing",TASK_CANCEL_EDITING_EVENT:"tasks:task_cancel_editing",HIDE_STATUS_DELAY:15,load:function(B){Tasks.table=$("tasks_list");if(!Tasks.table||Tasks.table.hasClassName("archived")){return}new ModalDialog($("add_list"),{afterShown:function(){$("new_list_name").activate()}});Tasks.addRow=Tasks.table.select("#add_row")[0];Tasks.addLink=Tasks.addRow.select("#add")[0];Tasks.tasksForm=$("tasks_form");Tasks.newTaskTableHTML=Tasks.tasksForm.innerHTML;Tasks.addLink.observe("click",Tasks.onClickAddTask);var C=Tasks.table.select("tr.task-row");for(var A=0;A<C.length;A+=2){new TaskRow(C[A+1],C[A])}Tasks.setHideStatus()},sortable:function(){return Tasks.table.hasClassName("sortable")},onClickAddTask:function(A){A.stop();Tasks.cancelAll();Tasks.doAddNewTask(Tasks.getNewTaskRow(),A.memo)},addCanceled:function(A){Tasks.addRow.show();Event.stopObserving(Tasks.table,Tasks.TASK_SAVED_EVENT,Tasks.addSaved);A.stop()},addSaved:function(A){Tasks.onClickAddTask(A)},doAddNewTask:function(D,A){var C=Tasks.table.select("tbody")[0];Tasks.addRow.remove();C.insert(D);C.insert(Tasks.addRow);if(A){["context","project"].each(function(G){var E="td."+G+">input";var F=A.select(E).first();var H=D.select(E).first();if(H&&F){H.setValue(F.getValue())}})}var B=new TaskRow(null,D);Tasks.table.observe(Tasks.TASK_SAVED_EVENT,Tasks.addSaved);D.observe(Tasks.TASK_CANCEL_EDITING_EVENT,Tasks.addCanceled);Tasks.addRow.hide();B.activate()},cancelAll:function(){Event.fire(Tasks.table,Tasks.TASK_EDITING_EVENT)},loadStatus:function(B){var A=B.select("div").find(function(D){return D.id=="status"});if(!A){return}var C=$("status");if(C){C.innerHTML=A.innerHTML;A=C}else{A.hide();Tasks.table.up("div").appendChild(A)}Tasks.showStatus();Tasks.setHideStatus()},setHideStatus:function(){if(Tasks.hideStatusTimeout){clearTimeout(Tasks.hideStatusTimeout)}Tasks.hideStatusTimeout=setTimeout(Tasks.hideStatus,Tasks.HIDE_STATUS_DELAY*1000)},hideStatus:function(){var A=$("status");if(!A){return}var B=A.immediateDescendants().collect(function(C){return new Effect.Fade(C,{sync:true})});new Effect.Parallel(B,{duration:0.1,afterFinish:function(){new Effect.BlindUp(A,{duration:0.1})}})},showStatus:function(){var A=$("status");if(!A||A.visible()){return}var B=A.immediateDescendants().collect(function(C){C.hide();return new Effect.Appear(C,{sync:true})});new Effect.BlindDown(A,{duration:0.1,afterFinish:function(){new Effect.Parallel(B,{duration:0.1})}})},updateStatusFromResponse:function(A){Tasks.loadStatus(Tasks.containerFromResponse(A))},updateProjects:function(B){var A=B.select("input[name=project]").first();A=A&&A.getValue();if(!A){return}DNZO.projects=[A,DNZO.projects.without(A)].flatten()},saveTask:function(E,F,B){var C=function(L,K,G){var J=L.select(G);var H=K.select(G);if(J.length!=H.length){return}var I=0;J.each(function(M){H[I].setValue(M.getValue());I+=1})};C(F,Tasks.tasksForm,"input[type=text]");var A="input[type=checkbox]";Tasks.tasksForm.select(A)[0].checked=F.select(A)[0].checked;var D=Tasks.tasksForm.action;Tasks.tasksForm.action=E?E:D;Tasks.tasksForm.request(B);Tasks.tasksForm.action=D;Tasks.updateProjects(F)},getNewTaskRow:function(){var A=new Element("div");A.innerHTML=Tasks.newTaskTableHTML;return A.select("tr")[0]},containerFromResponse:function(B){var A=new Element("div");A.innerHTML=B.responseText;return A},idFromViewRow:function(B){var A=B&&B.select("input.task-id").first();if(A){return A.getValue()}return null},doFail:function(A){alert("Ruh roh! Something went wrong. Please let us know what happened!")}};Event.observe(window,"load",Tasks.load);