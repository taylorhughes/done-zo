var Tasks={TASK_SAVED_EVENT:"tasks:task_saved",TASK_EDITING_EVENT:"tasks:task_editing",TASK_CANCEL_EDITING_EVENT:"tasks:task_cancel_editing",HIDE_STATUS_DELAY:15,load:function(B){new ModalDialog($("add_list"),{afterShown:function(){$("new_list_name").activate()}});Tasks.table=$("tasks_list");Tasks.addRow=Tasks.table.select("#add_row")[0];Tasks.addLink=Tasks.addRow.select("#add")[0];Tasks.tasksForm=$("tasks_form");Tasks.newTaskTableHTML=Tasks.tasksForm.innerHTML;Tasks.addLink.observe("click",Tasks.onClickAddTask);var C=Tasks.table.select("tr.task-row");for(var A=0;A<C.length;A+=2){new TaskRow(C[A+1],C[A])}Tasks.setHideStatus()},onClickAddTask:function(A){A.stop();Tasks.cancelAll();Tasks.doAddNewTask(Tasks.getNewTaskRow(),A.memo)},addCanceled:function(A){Tasks.addRow.show();Event.stopObserving(Tasks.table,Tasks.TASK_SAVED_EVENT,Tasks.addSaved);A.stop()},addSaved:function(A){Tasks.onClickAddTask(A)},doAddNewTask:function(D,A){var C=Tasks.table.select("tbody")[0];Tasks.addRow.remove();C.insert(D);C.insert(Tasks.addRow);if(A){["context","project"].each(function(G){var E="td."+G+">input";var F=A.select(E).first();var H=D.select(E).first();if(H&&F){H.setValue(F.getValue())}})}var B=new TaskRow(null,D);Tasks.table.observe(Tasks.TASK_SAVED_EVENT,Tasks.addSaved);D.observe(Tasks.TASK_CANCEL_EDITING_EVENT,Tasks.addCanceled);Tasks.addRow.hide();B.activate()},cancelAll:function(){Event.fire(Tasks.table,Tasks.TASK_EDITING_EVENT)},loadStatus:function(B){var A=B.select("div").find(function(D){return D.id=="status"});if(!A){return}var C=$("status");if(C){C.innerHTML=A.innerHTML;A=C}else{A.hide();Tasks.table.up("div").appendChild(A)}Tasks.showStatus();Tasks.setHideStatus()},setHideStatus:function(){if(Tasks.hideStatusTimeout){clearTimeout(Tasks.hideStatusTimeout)}Tasks.hideStatusTimeout=setTimeout(Tasks.hideStatus,Tasks.HIDE_STATUS_DELAY*1000)},hideStatus:function(){var A=$("status");if(!A){return}var B=A.immediateDescendants().collect(function(C){return new Effect.Fade(C,{sync:true})});new Effect.Parallel(B,{duration:0.25,afterFinish:function(){new Effect.BlindUp(A,{duration:0.25})}})},showStatus:function(){var A=$("status");if(!A||A.visible()){return}var B=A.immediateDescendants().collect(function(C){C.hide();return new Effect.Appear(C,{sync:true})});new Effect.BlindDown(A,{duration:0.25,afterFinish:function(){new Effect.Parallel(B,{duration:0.25})}})},updateStatusFromResponse:function(A){Tasks.loadStatus(Tasks.containerFromResponse(A))},saveTask:function(D,B){var C=function(J,I,E){var H=J.select(E);var F=I.select(E);if(H.length!=F.length){return}var G=0;H.each(function(K){F[G].setValue(K.getValue());G+=1})};C(D,Tasks.tasksForm,"input[type=text]");C(D,Tasks.tasksForm,"input[type=hidden]");var A="input[type=checkbox]";Tasks.tasksForm.select(A)[0].checked=D.select(A)[0].checked;Tasks.tasksForm.request(B)},getNewTaskRow:function(){var A=new Element("div");A.innerHTML=Tasks.newTaskTableHTML;return A.select("tr")[0]},containerFromResponse:function(B){var A=new Element("div");A.innerHTML=B.responseText;return A},doFail:function(A){alert("Ruh roh! Something went wrong. Please let us know what happened!")}};var TaskRow=Class.create({initialize:function(A,B){this.editEventsWired=false;if(A){this.viewRow=A;this.wireViewingEvents(this.viewRow)}if(B){this.editRow=B;if(!A||this.editRow.visible()){this.wireEditingEvents(this.editRow)}}this.boundOnOtherTaskEditing=this.onOtherTaskEditing.bind(this);Tasks.table.observe(Tasks.TASK_EDITING_EVENT,this.boundOnOtherTaskEditing)},wireViewingEvents:function(B){this.editLink=B.select(".edit>a.edit")[0];this.editLink.observe("click",this.onClickEdit.bind(this));this.trashcan=B.select(".edit>a.delete")[0];this.trashcan.observe("click",this.onClickTrash.bind(this));var A=B.select(".complete")[0];A.observe("click",this.onClickComplete.bind(this));B.observe("dblclick",this.onDoubleClickViewRow.bind(this))},wireEditingEvents:function(B){var A=B.select(".edit>input[type=submit]")[0];A.observe("click",this.onClickSave.bind(this));B.observe("keyup",this.onKeyUp.bind(this));this.cancelLink=B.select(".edit>a.cancel")[0];this.boundOnClickCancel=this.onClickCancel.bind(this);this.cancelLink.observe("click",this.boundOnClickCancel);this.wireProjectAutocomplete(B);this.wireContextAutocomplete(B);this.editEventsWired=true},wireProjectAutocomplete:function(D){var C=D.select("td.project>input").first();var A=D.select(".project-autocompleter").first();var B=A.select("a").first();C.observe("keyup",function(E){if(A.visible()){E.stop()}});new Ajax.Autocompleter(C,A,B.href,{method:"get",paramName:"q",frequency:0.2})},wireContextAutocomplete:function(C){var D=C.select("td.context>input").first();var A=C.select(".context-autocompleter").first();var B=A.select("a").first();D.observe("keyup",function(E){if(A.visible()){E.stop()}});new Ajax.Autocompleter(D,A,B.href,{method:"get",paramName:"q",frequency:0.2,tokens:[" ",",",";"]})},destroy:function(){if(this.viewRow){this.viewRow.remove()}if(this.editRow&&this.editRow.parentNode){this.editRow.remove()}this.ignoreCancels()},ignoreCancels:function(){Event.stopObserving(this.cancelLink,"click",this.boundOnClickCancel);this.cancelLink.href=null;Event.stopObserving(Tasks.table,Tasks.TASK_EDITING_EVENT,this.boundOnOtherTaskEditing)},isEditing:function(){return this.editRow&&this.editRow.visible()},fire:function(B,A){Event.fire((this.viewRow||this.editRow),B,A)},onClickEdit:function(A){A.stop();this.edit();this.activate()},onClickCancel:function(A){A.stop();this.cancel()},onClickTrash:function(A){A.stop();this.trash()},onClickSave:function(D){var E={x:D.pointerX(),y:D.pointerY()};if(E.x!=0||E.y!=0){var B=D.element();var C=B.getDimensions();var A=B.cumulativeOffset();inX=E.x>=A.left&&E.x<=A.left+C.width;inY=E.y>=A.top&&E.y<=A.top+C.height;if(inX&&inY){this.save()}}D.stop()},onClickComplete:function(B){if(this.isEditing()){return}var A=B.element();this.completeOrUncomplete(A.checked,{onFailure:(function(C){this.doFail();A.checked=!checked}).bind(this)})},onDoubleClickViewRow:function(C){C.stop();var A=C.element();var D=(A.match("td"))?A:A.up("td");var B=null;if(D){B=D.classNames().toArray().first();if(["edit","done"].include(B)){return}}this.edit();this.activate(B)},onKeyUp:function(A){switch(A.keyCode){case Event.KEY_RETURN:this.save();break;case Event.KEY_ESC:this.cancel();break}},onOtherTaskEditing:function(A){if(this.isEditing()){this.cancel()}},edit:function(){this.fire(Tasks.TASK_EDITING_EVENT);if(!this.editEventsWired){this.wireEditingEvents(this.editRow)}this.viewRow.hide();this.editRow.show();this.activate()},cancel:function(){this.fire(Tasks.TASK_CANCEL_EDITING_EVENT);if(this.viewRow){this.viewRow.show();this.editRow.hide()}else{this.destroy()}},trash:function(){if(!this.requestedTrash){this.requestedTrash=true;new Ajax.Request(this.trashcan.href,{method:"get",onSuccess:this.doTrash.bind(this),onFailure:this.doFail.bind(this),onComplete:(function(A){this.requestedTrash=false}).bind(this)})}},doTrash:function(A){Tasks.updateStatusFromResponse(A);this.destroy()},save:function(){if(!this.isSaving){this.isSaving=true;Tasks.saveTask(this.editRow,{onSuccess:this.doSave.bind(this),onFailure:this.doFail.bind(this),onComplete:(function(A){this.isSaving=false}).bind(this)});this.editRow.select("input").each(function(A){A.disable()});this.ignoreCancels();this.fire(Tasks.TASK_SAVED_EVENT,this.editRow)}},doSave:function(A){this.replaceRows(A)},completeOrUncomplete:function(A,B){var C={};if(A){C.force_complete=true}else{C.force_uncomplete=true}defaultOptions={method:"post",parameters:C,onSuccess:this.doComplete.bind(this)};if(B){for(p in B){defaultOptions[p]=B[p]}}new Ajax.Request(this.editLink.href,defaultOptions)},doComplete:function(A){this.replaceRows(A)},doFail:function(A){Tasks.doFail(A)},replaceRows:function(F){if(this.viewRow){this.viewRow.remove()}var B=this.editRow.parentNode;var A=Tasks.containerFromResponse(F);var D=A.select("tr");var E=D.find(function(G){return G.hasClassName("editable")});var C=D.without(E)[0];B.insertBefore(E,this.editRow);B.insertBefore(C,this.editRow);this.editRow.remove();this.initialize(C,E)},activate:function(B){if(!this.editRow){return}if(!B){var A=this.editRow.select("td.task>input").first();var E=this.editRow.select("td.project>input").first();if(A&&E){var D=E.getDimensions().width>0;if(A.getValue().blank()&&E.getValue().blank()&&D){E.activate()}else{A.activate()}}}else{var C=this.editRow.select("td."+B+">input").first();if(C){C.activate()}}}});Event.observe(window,"load",Tasks.load);