var Tasks={TASK_SAVED_EVENT:"tasks:task_saved",TASK_EDITING_EVENT:"tasks:task_editing",TASK_CANCEL_EDITING_EVENT:"tasks:task_cancel_editing",load:function(B){var A=$("switcher");if(A){Event.observe(A,"change",Tasks.onSwitchList)}if(!Prototype.Browser.IE){var C=$("add_list_link");if(C){Event.observe(C,"click",Tasks.onClickAddList)}}Tasks.table=$("tasks_list");if(Tasks.table&&!Tasks.table.hasClassName("archived")){Tasks.addRow=Tasks.table.select("#add_row")[0];Tasks.addLink=Tasks.addRow.select("#add")[0];Event.observe(Tasks.addLink,"click",Tasks.onClickAddTask);Tasks.table.select("tr.task-row").each(function(D){new TaskRow(D,null)})}},onClickAddList:function(C){C.stop();var B=$$("form#add_list");if(B.length==0){return}B=B[0];var A=prompt("Enter a name for your new list:");B.select("input[type=text]")[0].setValue(A);B.submit()},onClickAddTask:function(A){if(!Tasks.newTaskRequested){Tasks.newTaskRequested=true;new Ajax.Request(Tasks.addLink.href,{method:"get",onFailure:Tasks.doFail,onSuccess:Tasks.doAddBlankTask,onComplete:function(B){Tasks.newTaskRequested=false}})}A.stop()},doAddBlankTask:function(B){Tasks.cancelAll();var A=Tasks.rowFromResponse(B);Tasks.doAddNewTask(A)},addCanceled:function(A){Tasks.addRow.show();Event.stopObserving(Tasks.table,Tasks.TASK_SAVED_EVENT,Tasks.addSaved);A.stop()},addSaved:function(A){var B=A.memo;if(B){Tasks.doAddNewTask(B)}else{Tasks.onClickAddTask(A)}},doAddNewTask:function(C){var B=Tasks.table.select("tbody")[0];B.removeChild(Tasks.addRow);B.appendChild(C);B.appendChild(Tasks.addRow);var A=new TaskRow(null,C);Event.observe(Tasks.table,Tasks.TASK_SAVED_EVENT,Tasks.addSaved);Event.observe(Tasks.table,Tasks.TASK_CANCEL_EDITING_EVENT,Tasks.addCanceled);Tasks.addRow.hide();A.activate()},onSwitchList:function(A){document.location.href=$F(A.element())},cancelAll:function(){Event.fire(Tasks.table,Tasks.TASK_EDITING_EVENT)},loadStatus:function(B){var A=B.select("#status");if(A.length>0){A=A[0];var C=$("status");if(C){C.innerHTML=A.innerHTML;C.show()}else{Tasks.table.up("div").appendChild(A)}}},updateStatusFromResponse:function(A){Tasks.loadStatus(Tasks.containerFromResponse(A))},containerFromResponse:function(B){var A=new Element("div");A.innerHTML=B.responseText;return A},rowFromResponse:function(C){var A=Tasks.containerFromResponse(C);var B=A.select("tr");if(B.length>0){return B[0]}return null},doFail:function(A){alert("Ruh roh! Something went wrong. Please let us know what happened!")}};var TaskRow=Class.create({initialize:function(A,B){if(A){this.viewRow=A;this.wireViewingEvents(this.viewRow)}if(B){this.editRow=B;this.wireEditingEvents(this.editRow)}this.boundOnOtherTaskEditing=this.onOtherTaskEditing.bind(this);Event.observe(Tasks.table,Tasks.TASK_EDITING_EVENT,this.boundOnOtherTaskEditing)},destroy:function(){if(this.viewRow){this.viewRow.parentNode.removeChild(this.viewRow)}if(this.editRow&&this.editRow.parentNode){this.editRow.parentNode.removeChild(this.editRow)}Event.stopObserving(Tasks.table,Tasks.TASK_EDITING_EVENT,this.boundOnOtherTaskEditing)},wireViewingEvents:function(B){this.edit=B.select(".edit>a.edit")[0];Event.observe(this.edit,"click",this.onClickEdit.bind(this));this.trash=B.select(".edit>a.delete")[0];Event.observe(this.trash,"click",this.onClickTrash.bind(this));var A=B.select(".complete")[0];Event.observe(A,"click",this.onClickComplete.bind(this))},wireEditingEvents:function(C){var B=C.select(".edit>input[type=submit]")[0];Event.observe(B,"click",this.onClickSave.bind(this));var A=C.select(".edit>a.cancel")[0];Event.observe(A,"click",this.onClickCancel.bind(this))},isEditing:function(){return this.editRow&&this.editRow.parentNode},cancel:function(){this.fire(Tasks.TASK_CANCEL_EDITING_EVENT);if(this.viewRow){this.viewRow.show();this.viewRow.parentNode.removeChild(this.editRow)}else{this.destroy()}},onClickCancel:function(A){this.cancel();A.stop()},onClickEdit:function(A){this.fire(Tasks.TASK_EDITING_EVENT);if(this.editRow){this.viewRow.hide();this.viewRow.parentNode.insertBefore(this.editRow,this.viewRow)}else{if(!this.requestedEditRow){this.requestedEditRow=true;new Ajax.Request(this.edit.href,{method:"get",onSuccess:this.doEdit.bind(this),onFailure:this.doFail.bind(this),onComplete:(function(B){this.requestedEditRow=false}).bind(this)})}}A.stop()},doEdit:function(A){this.editRow=Tasks.rowFromResponse(A);this.viewRow.parentNode.insertBefore(this.editRow,this.viewRow);this.viewRow.hide();this.wireEditingEvents(this.editRow);this.activate()},onClickTrash:function(A){if(!this.requestedTrash){this.requestedTrash=true;new Ajax.Request(this.trash.href,{method:"get",onSuccess:this.doTrash.bind(this),onFailure:this.doFail.bind(this),onComplete:(function(B){this.requestedTrash=false}).bind(this)})}A.stop()},doTrash:function(A){this.destroy();Tasks.updateStatusFromResponse(A)},onClickSave:function(A){A.element().disable();this.editRow.up("form").request({onSuccess:this.doSave.bind(this),onFailure:this.doFail.bind(this)});A.stop()},doSave:function(D){var C=this.editRow.parentNode;if(this.viewRow){C.removeChild(this.viewRow)}this.viewRow=Tasks.rowFromResponse(D);this.wireViewingEvents(this.viewRow);C.insertBefore(this.viewRow,this.editRow);C.removeChild(this.editRow);this.editRow=null;var B=new Element("div");B.innerHTML=D.responseText;var A=B.select("#new_tasks .task-row");if(A&&A.length>0){A=A[0]}else{A=null}this.fire(Tasks.TASK_SAVED_EVENT,A)},onClickComplete:function(B){if(this.isEditing()){return}var A=B.element();var C={};if(A.checked){C.force_complete=true}else{C.force_uncomplete=true}new Ajax.Request(this.edit.href,{method:"post",parameters:C,onSuccess:this.doComplete.bind(this),onFailure:(function(D){this.doFail();A.checked=!checked}).bind(this)})},doComplete:function(B){var A=Tasks.rowFromResponse(B);this.viewRow.className=A.className},onOtherTaskEditing:function(A){if(this.isEditing()){this.cancel()}},doFail:function(A){Tasks.doFail(A)},fire:function(B,A){Event.fire((this.viewRow||this.editRow),B,A)},activate:function(){if(!this.editRow){return}this.editRow.select("input[type=text]").each(function(A){if(A.getValue().blank()){A.activate();throw $break}})}});Event.observe(window,"load",Tasks.load);