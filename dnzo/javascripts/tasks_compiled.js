var Tasks={TASK_SAVED_EVENT:"tasks:task_saved",TASK_EDITING_EVENT:"tasks:task_editing",TASK_CANCEL_EDITING_EVENT:"tasks:task_cancel_editing",load:function(B){var A=$("switcher");if(A){Event.observe(A,"change",Tasks.onSwitchList)}if(!Prototype.Browser.IE){var C=$("add_list_link");if(C){Event.observe(C,"click",Tasks.onClickAddList)}}Tasks.table=$("tasks_list");if(!Tasks.table||Tasks.table.hasClassName("archived")){return}Tasks.addRow=Tasks.table.select("#add_row")[0];Tasks.addLink=Tasks.addRow.select("#add")[0];Tasks.tasksForm=$("tasks_form");Tasks.newTaskTableHTML=Tasks.tasksForm.innerHTML;Event.observe(Tasks.addLink,"click",Tasks.onClickAddTask);Tasks.table.select("tr.task-row").each(function(D){new TaskRow(D,null)})},onClickAddList:function(C){C.stop();var B=$$("form#add_list");if(B.length==0){return}B=B[0];var A=prompt("Enter a name for your new list:");B.select("input[type=text]")[0].setValue(A);B.submit()},onClickAddTask:function(A){A.stop();Tasks.cancelAll();Tasks.doAddNewTask(Tasks.getNewTaskRow(),A.memo)},addCanceled:function(A){Tasks.addRow.show();Event.stopObserving(Tasks.table,Tasks.TASK_SAVED_EVENT,Tasks.addSaved);A.stop()},addSaved:function(A){Tasks.onClickAddTask(A)},doAddNewTask:function(F,B){var E=Tasks.table.select("tbody")[0];Tasks.addRow.remove();E.insert(F);E.insert(Tasks.addRow);if(B){var D=F.select("input[type=text]");var A=B.select("input[type=text]");D[0].setValue(A[0].getValue());D[2].setValue(A[2].getValue())}var C=new TaskRow(null,F);Event.observe(Tasks.table,Tasks.TASK_SAVED_EVENT,Tasks.addSaved);Event.observe(F,Tasks.TASK_CANCEL_EDITING_EVENT,Tasks.addCanceled);Tasks.addRow.hide();C.activate()},onSwitchList:function(A){document.location.href=$F(A.element())},cancelAll:function(){Event.fire(Tasks.table,Tasks.TASK_EDITING_EVENT)},loadStatus:function(B){var A=B.select("#status");if(A.length>0){A=A[0];var C=$("status");if(C){C.innerHTML=A.innerHTML;C.show()}else{Tasks.table.up("div").appendChild(A)}}},updateStatusFromResponse:function(A){Tasks.loadStatus(Tasks.containerFromResponse(A))},saveTask:function(D,B){var C=function(J,I,E){var H=J.select(E);var F=I.select(E);if(H.length!=F.length){return}var G=0;H.each(function(K){F[G].setValue(K.getValue());G+=1})};C(D,Tasks.tasksForm,"input[type=text]");C(D,Tasks.tasksForm,"input[type=hidden]");var A="input[type=checkbox]";Tasks.tasksForm.select(A)[0].checked=D.select(A)[0].checked;Tasks.tasksForm.request(B)},getNewTaskRow:function(){var A=new Element("div");A.innerHTML=Tasks.newTaskTableHTML;return A.select("tr")[0]},containerFromResponse:function(B){var A=new Element("div");A.innerHTML=B.responseText;return A},rowFromResponse:function(C){var A=Tasks.containerFromResponse(C);var B=A.select("tr");if(B.length>0){return B[0]}return null},doFail:function(A){alert("Ruh roh! Something went wrong. Please let us know what happened!")}};var TaskRow=Class.create({initialize:function(A,B){if(A){this.viewRow=A;this.wireViewingEvents(this.viewRow)}if(B){this.editRow=B;this.wireEditingEvents(this.editRow)}this.boundOnOtherTaskEditing=this.onOtherTaskEditing.bind(this);Event.observe(Tasks.table,Tasks.TASK_EDITING_EVENT,this.boundOnOtherTaskEditing)},destroy:function(){if(this.viewRow){this.viewRow.remove()}if(this.editRow&&this.editRow.parentNode){this.editRow.remove()}this.ignoreCancels()},ignoreCancels:function(){Event.stopObserving(this.cancelLink,"click",this.boundOnClickCancel);this.cancelLink.href=null;Event.stopObserving(Tasks.table,Tasks.TASK_EDITING_EVENT,this.boundOnOtherTaskEditing)},wireViewingEvents:function(B){this.edit=B.select(".edit>a.edit")[0];Event.observe(this.edit,"click",this.onClickEdit.bind(this));this.trash=B.select(".edit>a.delete")[0];Event.observe(this.trash,"click",this.onClickTrash.bind(this));var A=B.select(".complete")[0];Event.observe(A,"click",this.onClickComplete.bind(this))},wireEditingEvents:function(B){var A=B.select(".edit>input[type=submit]")[0];Event.observe(A,"click",this.onClickSave.bind(this));Event.observe(B,"keyup",this.onKeyUp.bind(this));this.cancelLink=B.select(".edit>a.cancel")[0];this.boundOnClickCancel=this.onClickCancel.bind(this);Event.observe(this.cancelLink,"click",this.boundOnClickCancel)},isEditing:function(){return this.editRow&&this.editRow.parentNode},cancel:function(){this.fire(Tasks.TASK_CANCEL_EDITING_EVENT);if(this.viewRow){this.viewRow.show();this.editRow.hide()}else{this.destroy()}},onClickCancel:function(A){this.cancel();A.stop()},onClickEdit:function(A){if(this.editRow){this.viewRow.hide();this.editRow.show();this.activate()}else{if(!this.requestedEditRow){this.requestedEditRow=true;new Ajax.Request(this.edit.href,{method:"get",onSuccess:this.doEdit.bind(this),onFailure:this.doFail.bind(this),onComplete:(function(B){this.requestedEditRow=false}).bind(this)})}}A.stop()},doEdit:function(A){this.fire(Tasks.TASK_EDITING_EVENT);this.editRow=Tasks.rowFromResponse(A);this.viewRow.parentNode.insertBefore(this.editRow,this.viewRow);this.viewRow.hide();this.wireEditingEvents(this.editRow);this.activate()},onClickTrash:function(A){if(!this.requestedTrash){this.requestedTrash=true;new Ajax.Request(this.trash.href,{method:"get",onSuccess:this.doTrash.bind(this),onFailure:this.doFail.bind(this),onComplete:(function(B){this.requestedTrash=false}).bind(this)})}A.stop()},doTrash:function(A){this.destroy();Tasks.updateStatusFromResponse(A)},onClickSave:function(A){if(A.pointerX()!=0||A.pointerY()!=0){this.save()}A.stop()},save:function(){if(!this.isSaving){this.isSaving=true;Tasks.saveTask(this.editRow,{onSuccess:this.doSave.bind(this),onFailure:this.doFail.bind(this),onComplete:(function(A){this.isSaving=false}).bind(this)});this.editRow.select("input").each(function(A){A.disable()});this.ignoreCancels();this.fire(Tasks.TASK_SAVED_EVENT,this.editRow)}},doSave:function(B){var A=this.editRow.parentNode;if(this.viewRow){this.viewRow.remove()}this.viewRow=Tasks.rowFromResponse(B);this.wireViewingEvents(this.viewRow);A.insertBefore(this.viewRow,this.editRow);this.editRow.remove();this.editRow=null},onClickComplete:function(B){if(this.isEditing()){return}var A=B.element();var C={};if(A.checked){C.force_complete=true}else{C.force_uncomplete=true}new Ajax.Request(this.edit.href,{method:"post",parameters:C,onSuccess:this.doComplete.bind(this),onFailure:(function(D){this.doFail();A.checked=!checked}).bind(this)})},doComplete:function(B){var A=Tasks.rowFromResponse(B);this.viewRow.className=A.className},onKeyUp:function(A){switch(A.keyCode){case Event.KEY_RETURN:this.save();break;case Event.KEY_ESC:this.cancel();break}},onOtherTaskEditing:function(A){if(this.isEditing()){this.cancel()}},doFail:function(A){Tasks.doFail(A)},fire:function(B,A){Event.fire((this.viewRow||this.editRow),B,A)},activate:function(){if(!this.editRow){return}this.editRow.select("input[type=text]").each(function(A){if(A.getValue().blank()){A.activate();throw $break}})}});Event.observe(window,"load",Tasks.load);